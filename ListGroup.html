<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Smart Group Manager</title>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f7f6; margin-top: 130px; }
    
    /* STICKY TOP BARS */
    #top-fixed-container {
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    #summary-bar {
      background: #1a252f; color: white; padding: 10px 20px; 
      display: flex; gap: 25px; align-items: center; border-bottom: 1px solid #34495e;
    }
    #nav-bar {
      background: #ffffff; color: #333; padding: 10px 20px;
      display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
      font-size: 0.85em; border-bottom: 1px solid #ccc;
    }

    /* SEARCH BOX WITH CLEAR ICON */
    #search-wrapper { position: relative; margin-left: auto; display: flex; align-items: center; }
    #search-input {
      padding: 6px 35px 6px 12px; border-radius: 20px; border: none; width: 180px;
      font-size: 0.9em; outline: none; color: #333;
    }
    #search-clear {
      position: absolute; right: 10px; cursor: pointer; color: #999;
      font-weight: bold; font-size: 18px; display: none; user-select: none;
    }
    #search-clear:hover { color: #e74c3c; }

    /* FLOATING ACTION DRAWER */
    #floating-controls {
      position: fixed; bottom: 20px; right: 20px; z-index: 2000;
      background: #ffffff; border: 1px solid #3498db; border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3); overflow: hidden;
      transition: all 0.3s ease; width: 50px; height: 50px;
    }
    #floating-controls.expanded { width: 300px; height: auto; }
    #drawer-toggle { background: #3498db; color: white; border: none; width: 50px; height: 50px; cursor: pointer; font-size: 24px; font-weight: bold; float: right; }
    #drawer-content { padding: 15px; display: none; flex-direction: column; gap: 12px; clear: both; }
    #floating-controls.expanded #drawer-content { display: flex; }

    /* Navigation Links */
    .nav-link { text-decoration: none; font-weight: bold; cursor: pointer; padding: 4px 10px; border-radius: 4px; border: 1px solid #ccc; }
    .nav-e { background-color: #d8eaff; color: #004a8f; border-color: #a0c4ff; }
    .nav-k { background-color: #ffe4f0; color: #8f004a; border-color: #ffb3d9; }
    .stat-val { color: #2ecc71; margin-left: 4px; font-weight: bold; }

    /* Regions & Collapsibility */
    .region-section { clear: both; margin-bottom: 15px; scroll-margin-top: 140px; border-radius: 4px; overflow: hidden; }
    .region-title { 
      font-size: 1.1em; font-weight: bold; padding: 12px; 
      display: flex; justify-content: space-between; align-items: center; 
      cursor: pointer; user-select: none;
    }
    .region-blue { background: #d8eaff; border-left: 8px solid #0070d6; color: #004a8f; }
    .region-pink { background: #ffe4f0; border-left: 8px solid #d6006e; color: #8f004a; }
    
    .region-content { display: none; padding: 15px; background: rgba(0,0,0,0.02); overflow: hidden; }
    .toggle-icon { margin-right: 10px; transition: transform 0.2s; font-size: 0.8em; display: inline-block; }
    .region-section.open .region-content { display: block; }
    .region-section.open .toggle-icon { transform: rotate(90deg); }
    .reg-stats { font-weight: normal; font-size: 0.85em; opacity: 0.8; margin-left: 10px; }

    /* Groups */
    .group-list { border: 1px solid #ccc; width: 220px; min-height: 100px; list-style-type: none; margin: 0 10px 10px 0; padding: 0 0 10px 0; float: left; background: #fafafa; border-radius: 5px; }
    .group-title { padding: 8px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; margin-bottom: 5px; border-top-left-radius: 4px; border-top-right-radius: 4px; }
    .grp-bg-e { background: #e3f2fd; color: #0d47a1; }
    .grp-bg-k { background: #fce4ec; color: #880e4f; }

    /* Names & Highlight Frame */
    .group-list li { 
      margin: 5px; padding: 8px; font-size: 0.85em; background: #fff; 
      border: 2px solid #ddd; cursor: move; display: flex; align-items: center; border-radius: 4px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .group-list li.selected-name {
      border-color: #3498db !important;
      box-shadow: 0 0 8px rgba(52, 152, 219, 0.5);
      background-color: #ebf5fb;
    }

    .gender-badge { font-size: 0.7em; font-weight: bold; padding: 2px 5px; background: #eee; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px; }
    .single-asterisk { color: #e74c3c !important; font-weight: bold; } 
    .double-asterisk { color: #27ae60 !important; font-weight: bold; }
    .btn-icon { border: none; background: none; cursor: pointer; opacity: 0.4; transition: opacity 0.2s; }
    .btn-icon:hover { opacity: 1; }
    .add-name-btn { width: 90%; border: 1px dashed #ccc; background: #f9f9f9; cursor: pointer; padding: 5px; font-weight: bold; color: #666; margin: 5px auto; display: block; }
    .ui-state-highlight { height: 35px; background: #fffde7; border: 1px dashed #fbc02d; margin: 5px; }
  </style>
  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
</head>
<body>

<div id="floating-controls">
    <button id="drawer-toggle" title="Settings/Files">âš™</button>
    <div id="drawer-content">
        <label style="font-weight:bold; font-size: 0.8em; color: #555;">IMPORT FILE:</label>
        <input type="file" id="fileInput" accept=".txt" style="font-size: 0.8em;">
        <hr style="border:0; border-top:1px solid #eee; margin: 5px 0;">
        <button id="saveTxtBtn" style="cursor:pointer; padding: 10px; background: #2ecc71; color: white; border: none; border-radius: 4px; font-weight:bold;">Save as TXT</button>
    </div>
</div>

<div id="top-fixed-container">
    <div id="summary-bar">
        <div>Regions:<span id="total-regions" class="stat-val">0</span></div>
        <div>Names:<span id="total-names" class="stat-val">0</span></div>
        <div id="search-wrapper">
          <input type="text" id="search-input" placeholder="Search names...">
          <span id="search-clear">Ã—</span>
        </div>
    </div>
    <div id="nav-bar">
        <span style="font-weight: bold; color: #666; margin-right: 10px;">Jump to:</span>
        <div id="nav-links-container" style="display:flex; gap:8px; flex-wrap: wrap;"></div>
    </div>
</div>

<div id="lists-container"></div>

<script>
/* --- UTILITIES --- */
function cleanText(str) {
    if (!str) return "";
    let cleaned = str.replace(/[Ã§Ã‡]/g, 'c').replace(/[ÄŸÄž]/g, 'g').replace(/[Ä±Ä°]/g, 'i').replace(/[Ã¶Ã–]/g, 'o').replace(/[ÅŸÅž]/g, 's').replace(/[Ã¼Ãœ]/g, 'u').trim();
    let prefix = "";
    if (cleaned.startsWith('**')) { prefix = "** "; cleaned = cleaned.substring(2).trim(); }
    else if (cleaned.startsWith('*')) { prefix = "* "; cleaned = cleaned.substring(1).trim(); }
    if (cleaned.length > 0) {
        cleaned = cleaned.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
    }
    return prefix + cleaned;
}

function updateMetrics() {
    $('#total-regions').text($('.region-section').length);
    $('#total-names').text($('.group-list li').length);
    
    const navItems = [];
    $('.region-section').each(function(index) {
        let eAll = $(this).find('li[data-gender="E"]').length;
        let kAll = $(this).find('li[data-gender="K"]').length;
        const regGender = kAll > eAll ? 'K' : 'E';
        
        const regName = $(this).find('.reg-name-txt').text();
        const grpCount = $(this).find('.group-list').length;
        const regTotalNames = $(this).find('li').length;
        
        $(this).find('.reg-grp-count').text(grpCount);
        $(this).find('.reg-name-count').text(regTotalNames);

        $(this).find('.group-list').each(function(){
            const liCount = $(this).find('li').length;
            $(this).find('.grp-count-label').text('(' + liCount + ')');
        });

        const sectionId = "region-" + index;
        $(this).attr('id', sectionId);
        $(this).find('.region-title').removeClass('region-blue region-pink').addClass(regGender === 'K' ? 'region-pink' : 'region-blue');
        navItems.push({ id: sectionId, name: regName, gen: regGender });
    });

    navItems.sort((a, b) => (a.gen !== b.gen) ? a.gen.localeCompare(b.gen) : a.name.localeCompare(b.name));

    const $navContainer = $('#nav-links-container').empty();
    navItems.forEach(item => {
        const genderClass = (item.gen === 'K') ? 'nav-k' : 'nav-e';
        $navContainer.append(`<a class="nav-link ${genderClass}" onclick="openAndJump('${item.id}')">${item.name}</a>`);
    });
}

function openAndJump(id) {
    const $sec = $('#' + id);
    $sec.addClass('open');
    document.getElementById(id).scrollIntoView({behavior: 'smooth'});
}

function createNameLi(name, gender, isManual = false) {
    let raw = cleanText(name), final = raw, aClass = "";
    if (isManual) {
        let stripped = raw.replace(/^\*+/, "").trim().toLowerCase();
        let exists = false;
        $('.name-text').each(function(){ if($(this).text().replace(/^\*+/, "").trim().toLowerCase() === stripped) exists = true; });
        final = (exists ? "** " : "* ") + raw.replace(/^\*+/, "").trim();
        aClass = exists ? "double-asterisk" : "single-asterisk";
    } else {
        if (name.startsWith('**')) aClass = "double-asterisk";
        else if (name.startsWith('*')) aClass = "single-asterisk";
    }
    return $(`<li class="ui-state-default" data-gender="${gender}">
      <span class="gender-badge">${gender}</span>
      <span class="name-text ${aClass}">${final}</span>
      <button class="btn-icon remove-name-btn">Ã—</button></li>`);
}

function createGroupHeader(groupName, gender, count = 0) {
    const f = cleanText(groupName);
    const bgClass = gender === 'K' ? 'grp-bg-k' : 'grp-bg-e';
    let aClass = f.startsWith('**') ? "double-asterisk" : (f.startsWith('*') ? "single-asterisk" : "");
    return $(`<div class="group-title ${bgClass}">
        <span class="group-title-text ${aClass}">${f} <span class="grp-count-label">(${count})</span></span>
        <div class="group-controls"><button class="btn-icon edit-group-btn">âœŽ</button><button class="btn-icon delete-group-btn">ðŸ—‘</button></div>
    </div>`);
}

function renderGroups(regions) {
    const $container = $('#lists-container').empty();
    
    const regionSortList = [];
    Object.keys(regions).forEach(regName => {
        let eTotal = 0, kTotal = 0;
        Object.values(regions[regName]).forEach(grp => {
            eTotal += grp.filter(n => n.gen === 'E').length;
            kTotal += grp.filter(n => n.gen === 'K').length;
        });
        regionSortList.push({ name: regName, gen: kTotal > eTotal ? 'K' : 'E', data: regions[regName] });
    });

    regionSortList.sort((a, b) => (a.gen !== b.gen) ? a.gen.localeCompare(b.gen) : a.name.localeCompare(b.name));

    regionSortList.forEach(regObj => {
        const $regionDiv = $(`<div class="region-section">
            <div class="region-title">
                <div class="reg-title-content">
                    <span class="toggle-icon">â–¶</span>
                    Region: <span class="reg-name-txt">${cleanText(regObj.name)}</span>
                    <span class="reg-stats">(<span class="reg-grp-count">0</span> Groups, <span class="reg-name-count">0</span> persons)</span>
                </div>
                <button class="add-group-btn" data-region="${regObj.name}" style="cursor:pointer; padding: 4px 10px; border-radius:3px; border:1px solid #ccc; background:white;">+ Add Group</button>
            </div>
            <div class="region-content"></div>
        </div>`);

        const $content = $regionDiv.find('.region-content');
        const groupData = [];
        Object.keys(regObj.data).forEach(gName => {
            const names = regObj.data[gName];
            let eC = names.filter(n => n.gen === 'E').length, kC = names.filter(n => n.gen === 'K').length;
            groupData.push({ name: gName, names: names, gen: kC > eC ? 'K' : 'E' });
        });

        groupData.sort((a, b) => (a.gen !== b.gen) ? a.gen.localeCompare(b.gen) : a.name.localeCompare(b.name));

        groupData.forEach(g => {
            const $ul = $(`<ul class="group-list connectedSortable" data-region="${regObj.name}" data-group="${g.name}"></ul>`);
            $ul.append(createGroupHeader(g.name, g.gen, g.names.length));
            g.names.sort((a,b) => cleanText(a.name).localeCompare(cleanText(b.name)));
            g.names.forEach(item => $ul.append(createNameLi(item.name, item.gen)));
            $ul.append(`<div class="add-btn-wrapper"><button class="add-name-btn">+ Add Name</button></div>`);
            $content.append($ul);
        });
        $container.append($regionDiv);
    });
    
    $(".connectedSortable").sortable({ 
        connectWith: ".connectedSortable", 
        items: "li", 
        placeholder: "ui-state-highlight", 
        start: function(e, ui) {
          $('.group-list li').removeClass('selected-name');
          ui.item.addClass('selected-name');
        },
        stop: updateMetrics 
    }).disableSelection();
    updateMetrics();
}

/* --- HANDLERS --- */

$(document).on('click', '.group-list li', function(e) {
    e.stopPropagation(); 
    $('.group-list li').removeClass('selected-name'); 
    $(this).addClass('selected-name'); 
});

$(document).on('click', function(e) {
    if (!$(e.target).closest('.group-list li').length) $('.group-list li').removeClass('selected-name');
});

$(document).on('click', '.region-title', function(e) {
    if ($(e.target).closest('button').length) return; 
    $(this).closest('.region-section').toggleClass('open');
});

$('#drawer-toggle').on('click', function() {
    $('#floating-controls').toggleClass('expanded');
    $(this).text($('#floating-controls').hasClass('expanded') ? 'âœ–' : 'âš™');
});

$(document).on('click', '.add-name-btn', function(e) {
    e.preventDefault();
    const $list = $(this).closest('.group-list');
    const existingNames = $list.find('li');
    
    let gen = "";
    if (existingNames.length > 0) {
        const genders = existingNames.map(function() { return $(this).attr('data-gender'); }).get();
        const allE = genders.every(g => g === 'E');
        const allK = genders.every(g => g === 'K');
        
        if (allE) gen = "E";
        else if (allK) gen = "K";
    }

    let name = prompt("Enter Name:"); 
    if (!name) return;

    if (!gen) {
        gen = prompt("Gender (E/K):", "E").toUpperCase();
        if (gen !== "E" && gen !== "K") gen = "E";
    }
    
    $(this).closest('.add-btn-wrapper').before(createNameLi(name, gen, true));
    updateMetrics();
});

$(document).on('click', '.add-group-btn', function(e) {
    e.preventDefault();
    let g = prompt("Group Name:"); if (!g) return;
    let name = g.trim().startsWith('*') ? g.trim() : "* " + g.trim();
    const region = $(this).data('region'), f = cleanText(name);
    const $ul = $(`<ul class="group-list connectedSortable" data-region="${region}" data-group="${f}"></ul>`);
    $ul.append(createGroupHeader(f, 'E', 0)).append(`<div class="add-btn-wrapper"><button class="add-name-btn">+ Add Name</button></div>`);
    $(this).closest('.region-section').find('.region-content').append($ul);
    $ul.sortable({ connectWith: ".connectedSortable", items: "li", start: function(e, ui){ $('.group-list li').removeClass('selected-name'); ui.item.addClass('selected-name'); }, stop: updateMetrics }).disableSelection();
    updateMetrics();
});

$(document).on('click', '.remove-name-btn', function(e) {
    e.stopPropagation();
    const nameTxt = $(this).siblings('.name-text').text();
    if (confirm(`Are you sure you want to delete "${nameTxt}"?`)) {
        $(this).closest('li').remove();
        updateMetrics();
    }
});

$(document).on('click', '.delete-group-btn', function(e) {
    e.stopPropagation();
    const grpName = $(this).closest('.group-title').find('.group-title-text').text();
    if (confirm(`âš ï¸ WARNING: This will delete group "${grpName}". Proceed?`)) {
        $(this).closest('.group-list').remove();
        updateMetrics();
    }
});

$(document).on('click', '.edit-group-btn', function(e) {
    e.stopPropagation();
    const $span = $(this).closest('.group-title').find('.group-title-text');
    let n = prompt("Edit Group Name:", $span.text());
    if (n) { $span.text(cleanText(n)); updateMetrics(); }
});

$('#fileInput').on('change', function(e) {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
        const regions = {};
        evt.target.result.split('\n').forEach(line => {
            if (!line.trim()) return;
            const p = line.split(',').map(item => item.trim());
            if (p.length < 3) return;
            if (!regions[p[0]]) regions[p[0]] = {};
            if (!regions[p[0]][p[1]]) regions[p[0]][p[1]] = [];
            regions[p[0]][p[1]].push({ name: p[2], gen: p[3]?.toUpperCase() || 'E' });
        });
        renderGroups(regions);
        $('#floating-controls').removeClass('expanded'); $('#drawer-toggle').text('âš™');
    };
    reader.readAsText(file);
});

$('#saveTxtBtn').click(function() {
    let txt = '';
    $('.region-section').each(function() {
        const reg = $(this).find('.reg-name-txt').text().trim();
        $(this).find('.group-list').each(function() {
            const grpFullText = $(this).find('.group-title-text').text();
            const grp = grpFullText.replace(/\s\(\d+\)$/, "").trim();
            $(this).find('li').each(function() {
                txt += `${reg},${grp},${$(this).find('.name-text').text()},${$(this).attr('data-gender')}\n`;
            });
        });
    });
    const blob = new Blob([txt], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'data_export.txt';
    link.click();
});

function performSearch() {
    const val = $('#search-input').val().toLowerCase();
    if (val === "") {
        $('#search-clear').hide();
        $('.region-section').removeClass('open');
        $('.region-section, .group-list, li').show();
        return;
    }
    $('#search-clear').show();
    $('.region-section').each(function() {
        let rMatch = false;
        $(this).find('.group-list').each(function() {
            let gMatch = false;
            $(this).find('li').each(function() {
                if ($(this).text().toLowerCase().includes(val)) { $(this).show(); gMatch = rMatch = true; } 
                else { $(this).hide(); }
            });
            gMatch ? $(this).show() : $(this).hide();
        });
        if (rMatch) { $(this).show().addClass('open'); } 
        else { $(this).hide().removeClass('open'); }
    });
}
$('#search-input').on('keyup', performSearch);
$('#search-clear').on('click', function() { $('#search-input').val(''); performSearch(); });
</script>
</body>
</html>
