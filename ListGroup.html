<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Dynamic Group Manager Pro</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
</head>
<body>

<div id="floating-controls">
    <button id="drawer-toggle" title="Settings/Files">âš™</button>
    <div id="drawer-content">
        <label style="font-weight:bold; font-size: 0.8em; color: #555;">IMPORT FILE:</label>
        <input type="file" id="fileInput" accept=".txt" style="font-size: 0.8em;">
        <hr style="border:0; border-top:1px solid #eee; margin: 5px 0;">
        <button id="saveTxtBtn" style="cursor:pointer; padding: 10px; background: #2ecc71; color: white; border: none; border-radius: 4px; font-weight:bold;">Save as TXT</button>
    </div>
</div>

<div id="top-fixed-container">
    <div id="summary-bar">
        <div>Regions:<span id="total-regions" class="stat-val">0</span></div>
        <div>Names:<span id="total-names" class="stat-val">0</span></div>
        <div id="search-wrapper">
          <input type="text" id="search-input" placeholder="Search names...">
          <span id="search-clear">Ã—</span>
        </div>
    </div>
    <div id="nav-bar">
        <span style="font-weight: bold; color: #666; margin-right: 10px;">Jump to:</span>
        <div id="nav-links-container" style="display:flex; gap:8px; flex-wrap: wrap;"></div>
    </div>
</div>

<div id="lists-container"></div>

<script>
/* --- UTILITY FUNCTIONS --- */
function cleanText(str) {
    if (!str) return "";
    let cleaned = str.replace(/[Ã§Ã‡]/g, 'c').replace(/[ÄŸÄž]/g, 'g').replace(/[Ä±Ä°]/g, 'i').replace(/[Ã¶Ã–]/g, 'o').replace(/[ÅŸÅž]/g, 's').replace(/[Ã¼Ãœ]/g, 'u').trim();
    let prefix = "";
    if (cleaned.startsWith('**')) { prefix = "** "; cleaned = cleaned.substring(2).trim(); }
    else if (cleaned.startsWith('*')) { prefix = "* "; cleaned = cleaned.substring(1).trim(); }
    if (cleaned.length > 0) {
        cleaned = cleaned.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
    }
    return prefix + cleaned;
}

function updateMetrics() {
    $('#total-regions').text($('.region-section').length);
    $('#total-names').text($('.group-list li').length);
    
    const navItems = [];
    $('.region-section').each(function(index) {
        let eAll = $(this).find('li[data-gender="E"]').length;
        let kAll = $(this).find('li[data-gender="K"]').length;
        const regGender = kAll > eAll ? 'K' : 'E';
        
        const regName = $(this).find('.reg-name-txt').text();
        $(this).find('.reg-grp-count').text($(this).find('.group-list').length);
        $(this).find('.reg-name-count').text($(this).find('li').length);

        $(this).find('.group-list').each(function(){
            $(this).find('.grp-count-label').text('(' + $(this).find('li').length + ')');
        });

        const sectionId = "region-" + index;
        $(this).attr('id', sectionId);
        $(this).find('.region-title').removeClass('region-blue region-pink').addClass(regGender === 'K' ? 'region-pink' : 'region-blue');
        navItems.push({ id: sectionId, name: regName, gen: regGender });
    });

    navItems.sort((a, b) => (a.gen !== b.gen) ? a.gen.localeCompare(b.gen) : a.name.localeCompare(b.name));
    const $navContainer = $('#nav-links-container').empty();
    navItems.forEach(item => {
        const genderClass = (item.gen === 'K') ? 'nav-k' : 'nav-e';
        $navContainer.append(`<a class="nav-link ${genderClass}" onclick="openAndJump('${item.id}')">${item.name}</a>`);
    });
}

function openAndJump(id) {
    $('#' + id).addClass('open');
    document.getElementById(id).scrollIntoView({behavior: 'smooth'});
}

/* --- DOM ELEMENT CREATION --- */
function createNameLi(name, gender, isManual = false) {
    let raw = cleanText(name), final = raw, aClass = "";
    if (isManual) {
        let stripped = raw.replace(/^\*+/, "").trim().toLowerCase();
        let exists = false;
        $('.name-text').each(function(){ if($(this).text().replace(/^\*+/, "").trim().toLowerCase() === stripped) exists = true; });
        let l = raw.replace(/^\*+/, "").trim().split(" ");
        let cleaned = "";
        for (let w of l) {
            if (w != "") {
                cleaned += w + ' ';
            }
        }
        cleaned = cleaned.trim();
        final = (exists ? "** " : "* ") + cleaned;
        aClass = exists ? "double-asterisk" : "single-asterisk";
    } else {
        if (name.startsWith('**')) aClass = "double-asterisk";
        else if (name.startsWith('*')) aClass = "single-asterisk";
    }
    return $(`<li class="ui-state-default" data-gender="${gender}">
      <span class="gender-badge">${gender}</span>
      <span class="name-text ${aClass}">${final}</span>
      <button class="btn-icon remove-name-btn">Ã—</button></li>`);
}

function createGroupHeader(groupName, gender, count = 0) {
    const f = cleanText(groupName);
    const bgClass = gender === 'K' ? 'grp-bg-k' : 'grp-bg-e';
    let aClass = f.startsWith('**') ? "double-asterisk" : (f.startsWith('*') ? "single-asterisk" : "");
    return $(`<div class="group-title ${bgClass}">
        <span class="group-title-text ${aClass}">${f} <span class="grp-count-label">(${count})</span></span>
        <div class="group-controls"><button class="btn-icon edit-group-btn">âœŽ</button><button class="btn-icon delete-group-btn">ðŸ—‘</button></div>
    </div>`);
}

/* --- RENDER & SORTABLE --- */
function renderGroups(regions) {
    const $container = $('#lists-container').empty();
    const regionSortList = [];
    Object.keys(regions).forEach(regName => {
        let eT = 0, kT = 0;
        Object.values(regions[regName]).forEach(grp => {
            eT += grp.filter(n => n.gen === 'E').length;
            kT += grp.filter(n => n.gen === 'K').length;
        });
        regionSortList.push({ name: regName, gen: kT > eT ? 'K' : 'E', data: regions[regName] });
    });

    regionSortList.sort((a, b) => (a.gen !== b.gen) ? a.gen.localeCompare(b.gen) : a.name.localeCompare(b.name));

    regionSortList.forEach(regObj => {
        const $regionDiv = $(`<div class="region-section">
            <div class="region-title">
                <div class="reg-title-content">
                    <span class="toggle-icon">â–¶</span>
                    Region: <span class="reg-name-txt">${cleanText(regObj.name)}</span>
                    <span class="reg-stats">(<span class="reg-grp-count">0</span> Groups, <span class="reg-name-count">0</span> persons)</span>
                </div>
                <button class="add-group-btn" data-region="${regObj.name}" style="cursor:pointer; padding: 4px 10px; border-radius:3px; border:1px solid #ccc; background:white;">+ Add Group</button>
            </div>
            <div class="region-content"></div>
        </div>`);

        const $content = $regionDiv.find('.region-content');
        const groupData = [];
        Object.keys(regObj.data).forEach(gName => {
            const names = regObj.data[gName];
            let eC = names.filter(n => n.gen === 'E').length, kC = names.filter(n => n.gen === 'K').length;
            groupData.push({ name: gName, names: names, gen: kC > eC ? 'K' : 'E' });
        });

        groupData.sort((a, b) => (a.gen !== b.gen) ? a.gen.localeCompare(b.gen) : a.name.localeCompare(b.name));

        groupData.forEach(g => {
            const $ul = $(`<ul class="group-list connectedSortable" data-region="${regObj.name}" data-group="${g.name}"></ul>`);
            $ul.append(createGroupHeader(g.name, g.gen, g.names.length));
            g.names.sort((a,b) => cleanText(a.name).localeCompare(cleanText(b.name)));
            g.names.forEach(item => $ul.append(createNameLi(item.name, item.gen)));
            $ul.append(`<div class="add-btn-wrapper"><button class="add-name-btn">+ Add Name</button></div>`);
            $content.append($ul);
        });
        $container.append($regionDiv);
    });
    
    initSortable();
    updateMetrics();
}

function initSortable() {
    $(".connectedSortable").sortable({ 
        connectWith: ".connectedSortable", 
        items: "li", 
        placeholder: "ui-state-highlight",
        start: function(e, ui) {
            if (!ui.item.hasClass('selected-name')) {
                $('.group-list li').removeClass('selected-name');
                ui.item.addClass('selected-name');
            }
            ui.item.siblings('.selected-name').appendTo(ui.item);
        },
        stop: function(e, ui) {
            const $newParent = ui.item.parent();
            ui.item.children('.selected-name').insertBefore(ui.item);
            
            const $liElements = $newParent.children('li').get();
            $liElements.sort((a, b) => cleanText($(a).find('.name-text').text()).localeCompare(cleanText($(b).find('.name-text').text())));
            $.each($liElements, (index, li) => $newParent.find('.add-btn-wrapper').before(li));

            updateMetrics();
        }
    }).disableSelection();
}

/* --- EVENT HANDLERS --- */

// Multi-select Click Logic
$(document).on('click', '.group-list li', function(e) {
    e.stopPropagation(); 
    if (!(e.ctrlKey || e.metaKey)) $('.group-list li').removeClass('selected-name');
    $(this).toggleClass('selected-name'); 
});

$(document).on('click', (e) => {
    if (!$(e.target).closest('.group-list li').length) $('.group-list li').removeClass('selected-name');
});

$(document).on('click', '.region-title', function(e) {
    if ($(e.target).closest('button').length) return; 
    $(this).closest('.region-section').toggleClass('open');
});

$('#drawer-toggle').on('click', function() {
    $('#floating-controls').toggleClass('expanded');
    $(this).text($('#floating-controls').hasClass('expanded') ? 'âœ–' : 'âš™');
});

$(document).on('click', '.add-name-btn', function(e) {
    e.preventDefault();
    const $list = $(this).closest('.group-list');
    const existing = $list.find('li');
    let gen = "";
    if (existing.length > 0) {
        const gs = existing.map(function() { return $(this).attr('data-gender'); }).get();
        if (gs.every(g => g === 'E')) gen = "E";
        else if (gs.every(g => g === 'K')) gen = "K";
    }
    let name = prompt("Enter Name:"); if (!name) return;
    if (!gen) { gen = prompt("Gender (E/K):", "E").toUpperCase(); if (gen !== "E" && gen !== "K") gen = "E"; }
    $(this).closest('.add-btn-wrapper').before(createNameLi(name, gen, true));
    updateMetrics();
});

$(document).on('click', '.add-group-btn', function(e) {
    e.preventDefault();
    let g = prompt("Group Name:"); if (!g) return;
    let name = g.trim().startsWith('*') ? g.trim() : "* " + g.trim();
    const region = $(this).data('region'), f = cleanText(name);
    const $ul = $(`<ul class="group-list connectedSortable" data-region="${region}" data-group="${f}"></ul>`);
    $ul.append(createGroupHeader(f, 'E', 0)).append(`<div class="add-btn-wrapper"><button class="add-name-btn">+ Add Name</button></div>`);
    $(this).closest('.region-section').find('.region-content').append($ul);
    initSortable();
    updateMetrics();
});

$(document).on('click', '.remove-name-btn', function(e) {
    e.stopPropagation();
    if (confirm(`Delete name?`)) { $(this).closest('li').remove(); updateMetrics(); }
});

$(document).on('click', '.delete-group-btn', function(e) {
    e.stopPropagation();
    if (confirm(`Delete group?`)) { $(this).closest('.group-list').remove(); updateMetrics(); }
});

$(document).on('click', '.edit-group-btn', function(e) {
    e.stopPropagation();
    const $span = $(this).closest('.group-title').find('.group-title-text');
    let n = prompt("Edit Group Name:", $span.text());
    if (n) { $span.text(cleanText(n)); updateMetrics(); }
});

$('#fileInput').on('change', function(e) {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
        const regions = {};
        evt.target.result.split('\n').forEach(line => {
            if (!line.trim()) return;
            const p = line.split(',').map(item => item.trim());
            if (p.length < 3) return;
            if (!regions[p[0]]) regions[p[0]] = {};
            if (!regions[p[0]][p[1]]) regions[p[0]][p[1]] = [];
            regions[p[0]][p[1]].push({ name: p[2], gen: p[3]?.toUpperCase() || 'E' });
        });
        renderGroups(regions);
        $('#floating-controls').removeClass('expanded'); $('#drawer-toggle').text('âš™');
    };
    reader.readAsText(file);
});

$('#saveTxtBtn').click(function() {
    let txt = '';
    $('.region-section').each(function() {
        const reg = $(this).find('.reg-name-txt').text().trim();
        $(this).find('.group-list').each(function() {
            const grpFullText = $(this).find('.group-title-text').text();
            const grp = grpFullText.replace(/\s\(\d+\)$/, "").trim();
            $(this).find('li').each(function() {
                txt += `${reg},${grp},${$(this).find('.name-text').text()},${$(this).attr('data-gender')}\n`;
            });
        });
    });
    const blob = new Blob([txt], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'data_export.txt';
    link.click();
});

function performSearch() {
    const val = $('#search-input').val().toLowerCase();
    if (val === "") {
        $('#search-clear').hide();
        $('.region-section').removeClass('open');
        $('.region-section, .group-list, li').show();
        return;
    }
    $('#search-clear').show();
    $('.region-section').each(function() {
        let rMatch = false;
        $(this).find('.group-list').each(function() {
            let gMatch = false;
            $(this).find('li').each(function() {
                if ($(this).text().toLowerCase().includes(val)) { $(this).show(); gMatch = rMatch = true; } 
                else { $(this).hide(); }
            });
            gMatch ? $(this).show() : $(this).hide();
        });
        if (rMatch) $(this).show().addClass('open');
        else $(this).hide().removeClass('open');
    });
}
$('#search-input').on('keyup', performSearch);
$('#search-clear').on('click', () => { $('#search-input').val(''); performSearch(); });
</script>
</body>
</html>

