<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Dynamic Group Manager - Color-Coded Nav</title>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f7f6; margin-top: 115px; }
    
    /* Sticky Bars */
    #top-fixed-container {
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    #summary-bar {
      background: #1a252f; color: white; padding: 10px 20px; 
      display: flex; gap: 25px; align-items: center; border-bottom: 1px solid #34495e;
    }
    #nav-bar {
      background: #ffffff; color: #333; padding: 10px 20px;
      display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
      font-size: 0.85em; border-bottom: 1px solid #ccc;
    }

    /* Color Coded Nav Links */
    .nav-link { 
      text-decoration: none; font-weight: bold; cursor: pointer;
      padding: 4px 10px; border-radius: 4px; border: 1px solid #ccc;
      transition: transform 0.1s;
    }
    .nav-link:active { transform: scale(0.95); }
    .nav-e { background-color: #d8eaff; color: #004a8f; border-color: #a0c4ff; }
    .nav-k { background-color: #ffe4f0; color: #8f004a; border-color: #ffb3d9; }
    .nav-link:hover { filter: brightness(90%); }

    .stat-val { color: #2ecc71; margin-left: 4px; font-weight: bold; }

    #search-input {
      padding: 6px 12px; border-radius: 20px; border: none; width: 200px;
      font-size: 0.9em; outline: none; margin-left: auto; color: #333;
    }

    #controls { 
      background: white; padding: 15px; border-radius: 8px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; 
      display: flex; gap: 15px; align-items: center;
    }

    .region-section { clear: both; margin-bottom: 30px; scroll-margin-top: 130px; }
    .region-title {
      font-size: 1.1em; font-weight: bold; padding: 10px; margin: 20px 0 10px 0;
      display: flex; justify-content: space-between; align-items: center; border-radius: 4px;
    }
    .region-blue { background: #d8eaff; border-left: 8px solid #0070d6; color: #004a8f; }
    .region-pink { background: #ffe4f0; border-left: 8px solid #d6006e; color: #8f004a; }

    .group-list {
      border: 1px solid #ccc; width: 220px; min-height: 80px; list-style-type: none;
      margin: 0 10px 10px 0; padding: 0; float: left; background: #fafafa; border-radius: 5px;
      padding-bottom: 10px;
    }
    .group-title {
      background: #ededed; padding: 8px; border-bottom: 1px solid #ddd;
      display: flex; justify-content: space-between; align-items: center; font-size: 0.9em;
      margin-bottom: 5px;
    }

    .group-list li {
      margin: 5px; padding: 8px; font-size: 0.85em; background: #fff;
      border: 1px solid #ddd; cursor: move; display: flex; align-items: center;
    }
    
    .gender-badge { font-size: 0.7em; font-weight: bold; padding: 2px 5px; background: #eee; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px; }
    .single-asterisk { color: #e74c3c !important; font-weight: bold; } 
    .double-asterisk { color: #27ae60 !important; font-weight: bold; }
    
    .btn-icon { border: none; background: none; cursor: pointer; opacity: 0.4; transition: opacity 0.2s; padding: 0 2px; }
    .btn-icon:hover { opacity: 1; }
    .add-name-btn { width: 90%; border: 1px dashed #ccc; background: #f9f9f9; cursor: pointer; padding: 5px; font-weight: bold; color: #666; margin: 5px auto; display: block; }
    .ui-state-highlight { height: 35px; background: #fffde7; border: 1px dashed #fbc02d; margin: 5px; }
  </style>
  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
</head>
<body>

<div id="top-fixed-container">
    <div id="summary-bar">
        <div>Regions:<span id="total-regions" class="stat-val">0</span></div>
        <div>Names:<span id="total-names" class="stat-val">0</span></div>
        <input type="text" id="search-input" placeholder="Search names...">
    </div>
    <div id="nav-bar">
        <span style="font-weight: bold; color: #666; margin-right: 5px;">Jump to Region:</span>
        <div id="nav-links-container" style="display:flex; gap:8px; flex-wrap: wrap;"></div>
    </div>
</div>

<div id="controls">
  <input type="file" id="fileInput" accept=".txt">
  <button id="saveTxtBtn" style="cursor:pointer; padding: 8px 25px; background: #3498db; color: white; border: none; border-radius: 4px; font-weight:bold;">Save as TXT</button>
</div>

<div id="lists-container"></div>

<script>
// --- UTILITIES ---
function cleanText(str) {
    if (!str) return "";
    let cleaned = str.replace(/Ã§/g, 'c').replace(/Ã‡/g, 'C').replace(/ÄŸ/g, 'g').replace(/Äž/g, 'G')
                     .replace(/Ä±/g, 'i').replace(/Ä°/g, 'I').replace(/Ã¶/g, 'o').replace(/Ã–/g, 'O')
                     .replace(/ÅŸ/g, 's').replace(/Åž/g, 'S').replace(/Ã¼/g, 'u').replace(/Ãœ/g, 'U').trim();
    let prefix = "";
    if (cleaned.startsWith('**')) { prefix = "** "; cleaned = cleaned.substring(2).trim(); }
    else if (cleaned.startsWith('*')) { prefix = "* "; cleaned = cleaned.substring(1).trim(); }
    if (cleaned.length > 0) {
        cleaned = cleaned.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
    }
    return prefix + cleaned;
}

function updateMetrics() {
    $('#total-regions').text($('.region-section').length);
    $('#total-names').text($('.group-list li').length);

    const $navContainer = $('#nav-links-container').empty();

    $('.region-section').each(function(index) {
        const firstLi = $(this).find('li').first();
        const gender = firstLi.length ? firstLi.attr('data-gender') : 'E';
        
        $(this).find('.region-title').removeClass('region-blue region-pink').addClass(gender === 'K' ? 'region-pink' : 'region-blue');
        
        const regName = $(this).find('.reg-name-txt').text();
        const count = $(this).find('.group-list').length;
        $(this).find('.reg-grp-count').text("(" + count + ")");

        const sectionId = "region-" + index;
        $(this).attr('id', sectionId);

        const genderClass = (gender === 'K') ? 'nav-k' : 'nav-e';
        $navContainer.append(`<a class="nav-link ${genderClass}" onclick="document.getElementById('${sectionId}').scrollIntoView({behavior: 'smooth'})">${regName}</a>`);
    });

    $('.group-list').each(function() {
        $(this).find('.grp-name-count').text("(" + $(this).find('li').length + ")");
    });
}

function createNameLi(name, gender, isAddingManual = false) {
    let rawName = cleanText(name); 
    let finalName = rawName;
    let asteriskClass = "";
    if (isAddingManual) {
        let stripped = rawName.replace(/^\*+/, "").trim().toLowerCase();
        let exists = false;
        $('.name-text').each(function(){
            if($(this).text().replace(/^\*+/, "").trim().toLowerCase() === stripped) exists = true;
        });
        if (exists) {
            finalName = "** " + rawName.replace(/^\*+/, "").trim(); asteriskClass = "double-asterisk";
        } else {
            finalName = "* " + rawName.replace(/^\*+/, "").trim(); asteriskClass = "single-asterisk";
        }
    } else {
        if (name.startsWith('**')) asteriskClass = "double-asterisk";
        else if (name.startsWith('*')) asteriskClass = "single-asterisk";
        finalName = name; 
    }
    return $(`<li class="ui-state-default" data-gender="${gender}">
      <span class="gender-badge">${gender}</span>
      <span class="name-text ${asteriskClass}">${finalName}</span>
      <button class="btn-icon remove-name-btn">Ã—</button>
  </li>`);
}

function createGroupHeader(groupName) {
    const formatted = cleanText(groupName);
    let asteriskClass = "";
    if (formatted.startsWith('**')) asteriskClass = "double-asterisk";
    else if (formatted.startsWith('*')) asteriskClass = "single-asterisk";
    return $(`
    <div class="group-title">
        <span class="group-title-text ${asteriskClass}">${formatted}</span>
        <span class="grp-name-count" style="font-size:0.8em; color:#7f8c8d;">(0)</span>
        <div class="group-controls">
            <button class="btn-icon edit-group-btn">âœŽ</button>
            <button class="btn-icon delete-group-btn">ðŸ—‘</button>
        </div>
    </div>
  `);
}

function renderGroups(regions) {
    const $container = $('#lists-container').empty();
    const sortedRegionKeys = Object.keys(regions).sort((a, b) => {
        const genA = regions[a][Object.keys(regions[a])[0]][0]?.gen || 'E';
        const genB = regions[b][Object.keys(regions[b])[0]][0]?.gen || 'E';
        return genA.localeCompare(genB);
    });

    sortedRegionKeys.forEach(region => {
        const $regionDiv = $(`<div class="region-section"></div>`);
        $regionDiv.append(`
            <div class="region-title">
                <div class="reg-title-content">Region: <span class="reg-name-txt">${cleanText(region)}</span> <span class="reg-grp-count"></span></div>
                <button class="add-group-btn" data-region="${region}" style="cursor:pointer; padding: 4px 10px; border-radius:3px; border:1px solid rgba(0,0,0,0.1); background:white;">+ Add Group</button>
            </div>`);

        Object.keys(regions[region]).sort().forEach(group => {
            const $ul = $(`<ul class="group-list connectedSortable" data-region="${region}" data-group="${group}"></ul>`);
            $ul.append(createGroupHeader(group));
            regions[region][group].sort((a, b) => cleanText(a.name).localeCompare(cleanText(b.name)))
                  .forEach(item => $ul.append(createNameLi(item.name, item.gen)));
            $ul.append(`<div class="add-btn-wrapper"><button class="add-name-btn">+ Add Name</button></div>`);
            $regionDiv.append($ul);
        });
        $container.append($regionDiv);
    });
    $(".connectedSortable").sortable({ connectWith: ".connectedSortable", items: "li", placeholder: "ui-state-highlight", stop: updateMetrics }).disableSelection();
    updateMetrics();
}

// --- SEARCH ---
$('#search-input').on('keyup', function() {
    const val = $(this).val().toLowerCase();
    if (val === "") { $('.group-list li, .group-list, .region-section').show(); return; }
    $('.region-section').each(function() {
        let regionMatch = false;
        $(this).find('.group-list').each(function() {
            let groupMatch = false;
            $(this).find('li').each(function() {
                if ($(this).find('.name-text').text().toLowerCase().includes(val)) {
                    $(this).show(); groupMatch = true; regionMatch = true;
                } else { $(this).hide(); }
            });
            groupMatch ? $(this).show() : $(this).hide();
        });
        regionMatch ? $(this).show() : $(this).hide();
    });
});

// --- GLOBAL EVENT DELEGATION (Fix for Google Sites) ---

$(document).on('click', '.edit-group-btn', function() {
    const $titleSpan = $(this).closest('.group-title').find('.group-title-text');
    let newName = prompt("Edit Group Name:", $titleSpan.text());
    if (newName && newName.trim() !== "") {
        const f = cleanText(newName);
        $titleSpan.text(f).removeClass('single-asterisk double-asterisk');
        if (f.startsWith('**')) $titleSpan.addClass('double-asterisk');
        else if (f.startsWith('*')) $titleSpan.addClass('single-asterisk');
        $(this).closest('.group-list').attr('data-group', f);
        updateMetrics();
    }
});

$(document).on('click', '.add-name-btn', function(e) {
    e.preventDefault();
    let name = prompt("Enter Name:"); if (!name) return;
    let gen = prompt("Gender (E/K):", "E").toUpperCase();
    $(this).closest('.add-btn-wrapper').before(createNameLi(name, gen, true));
    updateMetrics();
});

$(document).on('click', '.add-group-btn', function(e) {
    e.preventDefault();
    let g = prompt("Group Name:"); if (!g) return;
    let name = g.trim().startsWith('*') ? g.trim() : "* " + g.trim();
    const region = $(this).data('region'), f = cleanText(name);
    
    const $ul = $(`<ul class="group-list connectedSortable" data-region="${region}" data-group="${f}"></ul>`);
    $ul.append(createGroupHeader(f)).append(`<div class="add-btn-wrapper"><button class="add-name-btn">+ Add Name</button></div>`);
    
    $(this).closest('.region-section').append($ul);
    
    // Initialize sortable for the new list
    $ul.sortable({ 
        connectWith: ".connectedSortable", 
        items: "li", 
        placeholder: "ui-state-highlight",
        stop: updateMetrics 
    }).disableSelection();
    
    updateMetrics();
});

$(document).on('click', '.delete-group-btn', function() { if(confirm("Delete Group?")) { $(this).closest('.group-list').remove(); updateMetrics(); } });
$(document).on('click', '.remove-name-btn', function() { $(this).closest('li').remove(); updateMetrics(); });

$('#fileInput').on('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
        const regions = {};
        evt.target.result.split('\n').forEach(line => {
            if (!line.trim()) return;
            const p = line.split(',').map(item => item.trim());
            if (p.length < 3) return;
            if (!regions[p[0]]) regions[p[0]] = {};
            if (!regions[p[0]][p[1]]) regions[p[0]][p[1]] = [];
            regions[p[0]][p[1]].push({ name: p[2], gen: p[3]?.toUpperCase() || 'E' });
        });
        renderGroups(regions);
    };
    reader.readAsText(file);
});

$('#saveTxtBtn').click(function() {
    let txt = '';
    $('.region-section').each(function() {
        const reg = $(this).find('.reg-name-txt').text().trim();
        $(this).find('.group-list').each(function() {
            const grp = $(this).find('.group-title-text').text().trim();
            $(this).find('li').each(function() {
                txt += `${reg},${grp},${$(this).find('.name-text').text()},${$(this).attr('data-gender')}\n`;
            });
        });
    });
    const blob = new Blob([txt], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'data_export.txt';
    link.click();
});
</script>
</body>
</html>
